# 参考模型质量评分实现说明

## 概述

我已经为你实现了 `generate_quality_score` 方法，让参考模型能够生成分析过程和最终分数，最终分数用 `\box` 包围。

## 实现细节

### 1. 主要方法：`generate_quality_score`

在 `ActorRolloutRefWorker` 类中添加了 `generate_quality_score` 方法，该方法：

- **支持LoRA模式**：如果使用LoRA，会使用actor模型（不带LoRA）作为参考
- **支持独立参考模型**：如果有独立的参考模型，会使用参考模型进行评分
- **生成分析过程**：模型会生成详细的分析过程
- **提取最终分数**：从生成的文本中提取用 `\box` 包围的分数

### 2. 提示词构建：`_build_quality_score_prompts`

构建标准化的质量评分提示词：

```
请对以下回答进行质量评分：

问题：{input_text}

回答：{output_text}

请按以下格式进行评分：
1. 分析回答的准确性
2. 分析回答的完整性
3. 分析回答的逻辑性
4. 分析回答的清晰度
5. 综合评分（0-10分）

最终分数：\box{}
```

### 3. 分数提取：`_extract_quality_scores_from_generation`

从生成的文本中提取质量分数：

- **正则表达式匹配**：使用 `r'\\box\{([^}]+)\}'` 匹配 `\box` 中的内容
- **数字提取**：从匹配的文本中提取数字分数
- **分数标准化**：将0-10分的分数标准化到0-1范围
- **默认分数**：如果没有找到 `\box`，使用0.5作为默认分数

### 4. 集成到训练流程

在 `ray_trainer.py` 中的 `_compute_ref_quality_score` 函数已经简化：

- **直接调用**：直接调用 `generate_quality_score` 方法
- **简洁实现**：删除了复杂的备用方案和调试信息
- **核心功能**：专注于核心的质量评分功能

## 使用方式

### 1. 配置启用

在训练脚本中启用参考模型质量评分：

```bash
algorithm.ref_quality_score.enable=True \
algorithm.ref_quality_score.max_weight=0.3 \
algorithm.ref_quality_score.warmup_ratio=0.7 \
algorithm.ref_quality_score.schedule=linear
```

### 2. 模型输出示例

参考模型会生成类似这样的输出：

```
1. 分析回答的准确性：回答正确解决了问题，提供了准确的数学计算。

2. 分析回答的完整性：回答包含了完整的解题步骤，从问题分析到最终答案。

3. 分析回答的逻辑性：解题步骤逻辑清晰，每一步都有合理的推理。

4. 分析回答的清晰度：表达清晰，易于理解。

5. 综合评分（0-10分）：8分

最终分数：\box{8}
```

### 3. 分数提取

系统会自动从 `\box{8}` 中提取数字8，然后标准化为0.8（8/10）。

## 技术特点

### 1. 简洁性
- 删除了复杂的备用方案和调试信息
- 专注于核心功能实现
- 代码更加清晰易读

### 2. 可靠性
- 正则表达式匹配确保分数提取的准确性
- 默认分数机制确保系统稳定运行
- 异常处理确保训练不会中断

### 3. 高效性
- 直接调用参考模型生成质量评分
- 简化的分数提取逻辑
- 优化的tensor处理

## 监控指标

在SwanLab中可以看到以下指标：

- `actor/ref_quality/enabled`: 功能是否启用
- `actor/ref_quality/weight`: 当前混合权重
- `actor/ref_quality/mean_score`: 质量评分平均值
- `actor/ref_quality/max_score`: 质量评分最大值
- `actor/ref_quality/min_score`: 质量评分最小值
- `actor/ref_quality/std_score`: 质量评分标准差

## 注意事项

1. **生成时间**：质量评分生成需要额外的时间，因为需要调用模型生成文本
2. **内存使用**：生成过程会消耗额外的GPU内存
3. **分数准确性**：分数提取依赖于模型生成的格式，建议在训练前测试模型输出格式
4. **默认分数**：如果无法提取分数，系统会使用0.5作为默认分数

## 未来改进

1. **缓存机制**：可以添加缓存来避免重复计算
2. **批量优化**：可以优化批量处理效率
3. **格式验证**：可以添加格式验证来确保分数提取的准确性
4. **自定义提示**：可以支持自定义评分提示词
